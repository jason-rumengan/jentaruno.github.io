<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EasyChair</title>
    <style>
        .column {
            float: left;
            padding: 10px;
        }

        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        * {
            font-family: Arial;
        }
    </style>
</head>

<body>
    <h1>Chair Program</h1>
    <div class="row">
        <div class="column">
            <form id="inputDecision">
                <input type="text" name="judge" id="judge" required>
                <select name="decision1" id="decision1">
                    <option value="OG">OG</option>
                    <option value="OO">OO</option>
                    <option value="CG">CG</option>
                    <option value="CO">CO</option>
                </select>
                <select name="decision2" id="decision2">
                    <option value="OG">OG</option>
                    <option value="OO">OO</option>
                    <option value="CG">CG</option>
                    <option value="CO">CO</option>
                </select>
                <select name="decision3" id="decision3">
                    <option value="OG">OG</option>
                    <option value="OO">OO</option>
                    <option value="CG">CG</option>
                    <option value="CO">CO</option>
                </select>
                <select name="decision4" id="decision4">
                    <option value="OG">OG</option>
                    <option value="OO">OO</option>
                    <option value="CG">CG</option>
                    <option value="CO">CO</option>
                </select>
                <button type="submit" id="submitDecisionBtn">+</button>
            </form>
            <p style="color:red" id="inputDecisionStatus"></p>
            <table id="callTable">
                <thead>
                    <tr>
                        <th>Judge</th>
                        <th>1st</th>
                        <th>2nd</th>
                        <th>3rd</th>
                        <th>4th</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="callTbody"></tbody>
            </table>
        </div>

        <div class="column">
            The exchange(s) you should discuss, clearest to closest:
            <br>
            <table>
                <tbody id="dissentTable"></tbody>
            </table>
            <button id="finaliseDecisionBtn" style="display:none">Finalise</button>
            <p style="color:red" id="dissentTableStatus"></p>
        </div>
    </div>

    <script>
        const callFormEl = document.querySelector("#inputDecision");
        const callTbodyEl = document.querySelector("#callTbody");
        const callTableEl = document.querySelector("#callTable");
        const dissentTableEl = document.querySelector("#dissentTable");
        var finalOObeatOG;
        var finalCGbeatOG;
        var finalCGbeatOO;
        var finalCObeatOG;
        var finalCObeatOO;
        var finalCObeatCG;

        function $(x) { return document.getElementById(x); }

        function onInputDecision(e) {
            e.preventDefault();
            var Duplicate = checkDuplicate();
            if (!Duplicate) {
                const judge = $("judge").value;
                const decision1 = $("decision1").value;
                const decision2 = $("decision2").value;
                const decision3 = $("decision3").value;
                const decision4 = $("decision4").value;
                callTbodyEl.innerHTML += `
            <tr id=${judge}>
                <td>${judge}</td>
                <td>${decision1}</td>
                <td>${decision2}</td>
                <td>${decision3}</td>
                <td>${decision4}</td>
                <td><button class="deleteBtn">X</button></td>
            </tr>`;
            }
        }

        function onDeleteRow(e) {
            if (!e.target.classList.contains("deleteBtn"))
                return;
            e.target.closest("tr").remove();
            calculateDissent();
        }

        function onClearRadio(e) {
            if (!e.target.classList.contains("resolveBtn"))
                return;
            e.target.checked = false;
        }
        
        function checkDuplicate() {
            $("inputDecisionStatus").innerHTML = "";
            var teamarray = [];
            for (i = 1; i <= 4; i++) {
                teamarray[i] = $("decision" + i).value;
            }
            for (i = 1; i <= 4; i++) {
                for (j = i + 1; j <= 4; j++) {
                    if (i == j || teamarray[i] == "" || teamarray[j] == "")
                        continue;
                    if (teamarray[i] == teamarray[j]) {
                        $("inputDecisionStatus").innerHTML += "The same team cannot get two different ranks";
                        return true;
                    }
                }
            }
            for (i = 1; i <= callTbodyEl.rows.length; i++) {
                if ($("judge").value == callTableEl.rows[i].cells[0].innerHTML) {
                    callTableEl.rows[i].cells[1].innerHTML = $("decision1").value;
                    callTableEl.rows[i].cells[2].innerHTML = $("decision2").value;
                    callTableEl.rows[i].cells[3].innerHTML = $("decision3").value;
                    callTableEl.rows[i].cells[4].innerHTML = $("decision4").value;
                    return true;
                }
            }
        }

        function calculateDissent() {
            var rankOG = [];
            var rankOO = [];
            var rankCG = [];
            var rankCO = [];
            var OObeatOG = 0;
            var CGbeatOG = 0;
            var CGbeatOO = 0;
            var CObeatOG = 0;
            var CObeatOO = 0;
            var CObeatCG = 0;
            var OGTopTwo = 0;
            var OOTopTwo = 0;
            var CGTopTwo = 0;
            var COTopTwo = 0;
            var DistanceOOOG = 0;
            var DistanceCGOG = 0;
            var DistanceCGOO = 0;
            var DistanceCOOG = 0;
            var DistanceCOOO = 0;
            var DistanceCOCG = 0;
            var PriorityOOOG = 0;
            var PriorityCGOG = 0;
            var PriorityCGOO = 0;
            var PriorityCOOG = 0;
            var PriorityCOOO = 0;
            var PriorityCOCG = 0;
            $("dissentTable").innerHTML = "";

            if (callTbodyEl.rows.length > 1) {
                for (i = 0; i < callTbodyEl.rows.length; i++) {
                    for (var j = 1; j <= 4; j++) {
                        if (callTbodyEl.rows[i].cells[j].innerHTML == "OG")
                            rankOG[i] = j;
                        if (callTbodyEl.rows[i].cells[j].innerHTML == "OO")
                            rankOO[i] = j;
                        if (callTbodyEl.rows[i].cells[j].innerHTML == "CG")
                            rankCG[i] = j;
                        if (callTbodyEl.rows[i].cells[j].innerHTML == "CO")
                            rankCO[i] = j;
                    }
                    if (rankOO[i] < rankOG[i]) OObeatOG += 1;
                    if (rankCG[i] < rankOG[i]) CGbeatOG += 1;
                    if (rankCG[i] < rankOO[i]) CGbeatOO += 1;
                    if (rankCO[i] < rankOG[i]) CObeatOG += 1;
                    if (rankCO[i] < rankOO[i]) CObeatOO += 1;
                    if (rankCO[i] < rankCG[i]) CObeatCG += 1;
                    if (rankOG[i] <= 2) OGTopTwo += 1;
                    if (rankOO[i] <= 2) OOTopTwo += 1;
                    if (rankCG[i] <= 2) CGTopTwo += 1;
                    if (rankCO[i] <= 2) COTopTwo += 1;
                    DistanceOOOG = Math.abs(rankOO[i] - rankOG[i]);
                    DistanceCGOG = Math.abs(rankCG[i] - rankOG[i]);
                    DistanceCGOO = Math.abs(rankCG[i] - rankOO[i]);
                    DistanceCOOG = Math.abs(rankCO[i] - rankOG[i]);
                    DistanceCOOO = Math.abs(rankCO[i] - rankOO[i]);
                    DistanceCOCG = Math.abs(rankCO[i] - rankCG[i]);
                }
                if (OObeatOG == callTbodyEl.rows.length) finalOObeatOG = true;
                if (CGbeatOG == callTbodyEl.rows.length) finalCGbeatOG = true;
                if (CGbeatOO == callTbodyEl.rows.length) finalCGbeatOO = true;
                if (CObeatOG == callTbodyEl.rows.length) finalCObeatOG = true;
                if (CObeatOO == callTbodyEl.rows.length) finalCObeatOO = true;
                if (CObeatCG == callTbodyEl.rows.length) finalCObeatCG = true;
                if (OObeatOG == 0) finalOObeatOG = false;
                if (CGbeatOG == 0) finalCGbeatOG = false;
                if (CGbeatOO == 0) finalCGbeatOO = false;
                if (CObeatOG == 0) finalCObeatOG = false;
                if (CObeatOO == 0) finalCObeatOO = false;
                if (CObeatCG == 0) finalCObeatCG = false;
                if (OObeatOG < (callTbodyEl.rows.length / 2)) OObeatOG = callTbodyEl.rows.length - OObeatOG;
                if (CGbeatOG < (callTbodyEl.rows.length / 2)) CGbeatOG = callTbodyEl.rows.length - CGbeatOG;
                if (CGbeatOO < (callTbodyEl.rows.length / 2)) CGbeatOO = callTbodyEl.rows.length - CGbeatOO;
                if (CObeatOG < (callTbodyEl.rows.length / 2)) CObeatOG = callTbodyEl.rows.length - CObeatOG;
                if (CObeatOO < (callTbodyEl.rows.length / 2)) CObeatOO = callTbodyEl.rows.length - CObeatOO;
                if (CObeatCG < (callTbodyEl.rows.length / 2)) CObeatCG = callTbodyEl.rows.length - CObeatCG;
                if (OGTopTwo < (callTbodyEl.rows.length / 2)) OGTopTwo = callTbodyEl.rows.length - OGTopTwo;
                if (OOTopTwo < (callTbodyEl.rows.length / 2)) OOTopTwo = callTbodyEl.rows.length - OOTopTwo;
                if (CGTopTwo < (callTbodyEl.rows.length / 2)) CGTopTwo = callTbodyEl.rows.length - CGTopTwo;
                if (COTopTwo < (callTbodyEl.rows.length / 2)) COTopTwo = callTbodyEl.rows.length - COTopTwo;
                PriorityOOOG = OObeatOG + 0.01 * (OOTopTwo + OGTopTwo) + 1 / (100 * DistanceOOOG) + 0.0006;
                PriorityCGOG = CGbeatOG + 0.01 * (CGTopTwo + OGTopTwo) + 1 / (100 * DistanceCGOG) + 0.0005;
                PriorityCGOO = CGbeatOO + 0.01 * (CGTopTwo + OOTopTwo) + 1 / (100 * DistanceCGOO) + 0.0004;
                PriorityCOOG = CObeatOG + 0.01 * (COTopTwo + OGTopTwo) + 1 / (100 * DistanceCOOG) + 0.0003;
                PriorityCOOO = CObeatOO + 0.01 * (COTopTwo + OOTopTwo) + 1 / (100 * DistanceCOOO) + 0.0002;
                PriorityCOCG = CObeatCG + 0.01 * (COTopTwo + CGTopTwo) + 1 / (100 * DistanceCOCG) + 0.0001;
                var clearestCall = [{ key: "OG-OO", value: PriorityOOOG },
                { key: "OG-CG", value: PriorityCGOG },
                { key: "OO-CG", value: PriorityCGOO },
                { key: "OG-CO", value: PriorityCOOG },
                { key: "OO-CO", value: PriorityCOOO },
                { key: "CG-CO", value: PriorityCOCG }];
                clearestCall.sort(function (a, b) {
                    return b.value - a.value;
                });
                for (i = 0; i < 6; i++) {
                    if (clearestCall[i].value >= callTbodyEl.rows.length)
                        continue;
                    $("dissentTable").innerHTML += `
                    <tr>
                        <td>
                        <input type="radio" class="resolveBtn" name="*${clearestCall[i].key}" id="More${clearestCall[i].key}"></input>
                        </td>
                        <td>${clearestCall[i].key}</td>
                        <td>
                        <input type="radio" class="resolveBtn" name="*${clearestCall[i].key}" id="Less${clearestCall[i].key}"></input>
                        </td>
                    </tr>`;
                }
            }
            if ($("dissentTable").rows.length < 1)
                $("finaliseDecisionBtn").style.display = "none";
            else
                $("finaliseDecisionBtn").style.display = "block";
            $("dissentTableStatus").innerHTML = "";
        }

        function onFinalise() {
            var finalRankOG = 1;
            var finalRankOO = 1;
            var finalRankCG = 1;
            var finalRankCO = 1;
            $("dissentTableStatus").innerHTML = "";
            var dissents = document.getElementsByClassName("resolveBtn")
            var resolvesChecked = 0;
            for (i = 0; i < dissents.length; i++) {
                if (dissents[i].checked) {
                    resolvesChecked += 1;
                    if (dissents[i].id === "MoreOG-OO") finalOObeatOG = false;
                    if (dissents[i].id === "LessOG-OO") finalOObeatOG = true;
                    if (dissents[i].id === "MoreOG-CG") finalCGbeatOG = false;
                    if (dissents[i].id === "LessOG-CG") finalCGbeatOG = true;
                    if (dissents[i].id === "MoreOO-CG") finalCGbeatOO = false;
                    if (dissents[i].id === "LessOO-CG") finalCGbeatOO = true;
                    if (dissents[i].id === "MoreOG-CO") finalCObeatOG = false;
                    if (dissents[i].id === "LessOG-CO") finalCObeatOG = true;
                    if (dissents[i].id === "MoreOO-CO") finalCObeatOO = false;
                    if (dissents[i].id === "LessOO-CO") finalCObeatOO = true;
                    if (dissents[i].id === "MoreCG-CO") finalCObeatCG = false;
                    if (dissents[i].id === "LessCG-CO") finalCObeatCG = true;
                }
            }
            if (resolvesChecked < dissents.length / 2) {
                $("dissentTableStatus").innerHTML = "Not resolved!";
                return;
            }
            if (finalOObeatOG) finalRankOG += 1;
            else finalRankOO += 1;
            if (finalCGbeatOG) finalRankOG += 1;
            else finalRankCG += 1;
            if (finalCGbeatOO) finalRankOO += 1;
            else finalRankCG += 1;
            if (finalCObeatOG) finalRankOG += 1;
            else finalRankCO += 1;
            if (finalCObeatOO) finalRankOO += 1;
            else finalRankCO += 1;
            if (finalCObeatCG) finalRankCG += 1;
            else finalRankCO += 1;
            var finalRanks = [{ key: "OG", value: finalRankOG },
            { key: "OO", value: finalRankOO },
            { key: "CG", value: finalRankCG },
            { key: "CO", value: finalRankCO }]
            finalRanks.sort(function (a, b) {
                return a.value - b.value;
            });
            var filter1 = [finalRankOG, finalRankOO, finalRankCG, finalRankCO]
            var filter2 = filter1.filter((item, index) => filter1.indexOf(item) !== index);
            if (filter2.length > 0) {
                $("dissentTableStatus").innerHTML += "Error in dissent resolutions for these teams:<br>"
                for (i = 0; i < finalRanks.length; i++) {
                    if (filter2.includes(finalRanks[i].value))                    
                        $("dissentTableStatus").innerHTML += `${finalRanks[i].key} <br>`;
                }
                return;
            }
            $("dissentTableStatus").innerHTML += `<b>Final call: </b>
                                                <br>${finalRanks[0].value}. ${finalRanks[0].key}
                                                <br>${finalRanks[1].value}. ${finalRanks[1].key}
                                                <br>${finalRanks[2].value}. ${finalRanks[2].key}
                                                <br>${finalRanks[3].value}. ${finalRanks[3].key}`;
        }
        
        callFormEl.addEventListener("submit", onInputDecision);
        callFormEl.addEventListener("submit", calculateDissent);
        callTableEl.addEventListener("click", onDeleteRow);
        dissentTableEl.addEventListener("dblclick", onClearRadio);
        $("finaliseDecisionBtn").addEventListener("click", onFinalise);

    </script>
</body>

</html>